#!/usr/bin/env bash
# yadm bootstrap script
# Installs all my packages/sets up my environment.
#
# Checks for the presence of the $ON_OS variable,
# which is set in ~/.profile by checking `uname`
# on linux. Since the ~/.profile is sourced at the
# beginning of the Xsession and not when opening
# a shell, it can be assumed that its always set
# once `yadm clone` has been run and the computer
# has been restarted.

print_error() {
	havecmd notify 2>/dev/null && notify -u critical "bootstrap error" "$1"
	printf '%s%s%s\n' "$(tput setaf 1)" "$1" "$(tput sgr0)" 1>&2
} && export -f print_error

abort() {
	print_error "$1"
	exit 1
} && export -f abort

# install my package list parser/machine detection code
install_go_cmds() {
	havecmd go || return $?
	if ! havecmd spkglist; then
		go install -v 'github.com/seanbreckenridge/spkglist/cmd/spkglist@latest' || return $?
	fi
	if ! havecmd on_machine; then
		go install -v 'github.com/seanbreckenridge/on_machine/cmd/on_machine@latest' || return $?
	fi
} && export -f install_go_cmds

declare -rx YADM_DIR="${HOME}/.config/yadm"
declare -rx PACKAGE_DIR="${YADM_DIR}/package_lists"

# report errors if user doesn't have a command
export HAVECMD_REPORT=1

# make sure my $PATH is setup properly
havecmd havecmd || {
	# optionally let me continue - this may be the first time I'm running this
	# on android and I need to install zsh/setup defaults
	printf 'No havecmd; continue anyways? [Ctrl+C to Cancel] '
	read -r || exit $?
}

ON_OS="${ON_OS:=$(on_machine)}"
declare -rx ON_OS

# match files in ~/.config/yadm, run based on OS
# https://github.com/seanbreckenridge/on_machine
# e.g. run the android_bootstrap, linux_bootstrap, mac_bootstrap files
while read -r -d $'\0' bootstrap_script; do
	printf 'Executing %s\n' "$bootstrap_script"
	bash "$bootstrap_script" || exit $?
done < <(on_machine -cmd match -print0 -filter file -base "${YADM_DIR}" '%o_bootstrap')

declare -rx PYTHON_PACKAGE_LIST="${PACKAGE_DIR}/python3_packages.txt"
declare -rx PIPX_PACKAGE_LIST="${PACKAGE_DIR}/pipx_packages.txt"
declare -rx GLOBAL_GEM_LIST="${PACKAGE_DIR}/ruby_packages.txt"
declare -rx NPM_PACKAGE_LIST="${PACKAGE_DIR}/npm_packages.txt"
declare -rx COMPUTER_NPM_PACKAGE_LIST="${PACKAGE_DIR}/computer_npm_packages.txt"
declare -rx BASH_PACKAGE_LIST="${PACKAGE_DIR}/bash_packages.txt"

# make sure personal aliases file exists so that zshrc souces fine
[[ ! -f "${ZDOTDIR}/aliases/personal_aliases" ]] && touch "${ZDOTDIR}/aliases/personal_aliases"

# data directory for https://github.com/seanbreckenridge/HPI
[[ -n "${HPIDATA}" && ! -d "${HPIDATA}" ]] && mkdir -p "${HPIDATA}"

havecmd git || exit $?
echo 'Checking git config...'
# check for global name config
if [[ -z $(git config --global user.name) ]]; then
	printf "No global name set. Enter full name: "
	read -r githubusername
	git config --global user.name "${githubusername}"
fi
# check for global email config
if [[ -z $(git config --global user.email) ]]; then
	printf "No global email set. Enter email connected to your GitHub account: "
	read -r githubemail
	git config --global user.email "${githubemail}"
fi

# set editor to use as nvim
git config --global core.editor nvim
# specify how to handle divergent branches
git config --global pull.rebase false
git config --global core.pager 'less -i'
# set similar configuration for yadm itself
yadm gitconfig core.editor nvim
yadm gitconfig pull.rebase false
yadm gitconfig core.pager 'less -i'

# set the hooks directory
yadm gitconfig core.hooksPath "${HOME}/.config/yadm/hooks"

havecmd python3 || exit $?
# Install python packages -- even when on android, I use this enough/do
# enough scripting here that its worth it
echo "Installing global python site-packages..."
# upgrade pip
python3 -m pip install --user -U pip
# install wheel
python3 -m pip list --format=freeze | cut -d "=" -f1 | grep -qx "wheel" || python3 -m pip install --user wheel
python3 -m pip install --user -q -r "${PYTHON_PACKAGE_LIST}"
# install random personal stuff I want importable from anywhere

install_personal_pkg() {
	if havecmd reorder_editable; then
		if reorder_editable cat | grep -q "${HOME}/.config/seanb"; then
			# shellcheck disable=SC2088
			echo '~/.config/seanb already installed as editable'
			return
		fi
	fi
	python3 -m pip install --user -e "${HOME}/.config/seanb"
}

install_personal_pkg

# Install personal python packages
# If command "$1" doesn't exist, install from $2
function install_python_personal() {
	havecmd "${1}" || python3 -m pip install --user "git+${2}"
} && export -f install_python_personal

install_python_personal "mystars" "https://github.com/seanbreckenridge/oh-my-stars"
install_python_personal "shortcuts" "https://github.com/seanbreckenridge/shortcuts"

PIPX_INSTALLED="$(pipx list --json 2>/dev/null | jq '.venvs | keys[]' -r)"
while read -r pipx_pkg; do
	if ! grep -qx "${pipx_pkg}" <<<"${PIPX_INSTALLED}"; then
		printf "Installing %s\n" "$pipx_pkg"
		pipx install "${pipx_pkg}"
	fi
done < <(spkglist "${PIPX_PACKAGE_LIST}")

# speedtest installs 2 executable scripts
# speedtest and speedtest-cli, which both have the same
# functionatly. This removes speedtest-cli to make
# tab completion nicer
HAVECMD_REPORT='' havecmd speedtest-cli && rm "$(command -v speedtest-cli)"

# stuff to install on computers (linux/mac/windows), but not on android
[[ "$ON_OS" =~ ^android.* ]] || {
	printf 'Executing %s\n' "${YADM_DIR}/computer_bootstrap"
	bash "${YADM_DIR}/computer_bootstrap" || exit $?
}

npm_install_from_pkg_list() {
	local npm_installed="$1"
	local package_list="$2"
	while read -r npkg; do
		if ! grep -qx "${npkg}" <<<"${npm_installed}"; then
			printf "Installing %s\n" "$npkg"
			npm install --global "${npkg}"
		fi
	done < <(spkglist "${package_list}")
}

havecmd npm || exit $?
# install npm packages
export NPM_CONFIG_PREFIX="${XDG_DATA_HOME}/npm-packages"
echo "Installing global npm packages..."
NPM_LOC="$(command -v npm)"
if is_npm_path_unmangled "$NPM_LOC"; then
	# create the npm directory and make sure we own the directory to fix permission issues
	[[ ! -d "${NPM_CONFIG_PREFIX}" ]] && mkdir -p "${NPM_CONFIG_PREFIX}" && sudo chown -R "$(whoami)" "${NPM_CONFIG_PREFIX}"
	# get a list of installed packages
	NPM_INSTALLED="$(npm ls -g --json | jq '.dependencies | keys[]' -r)"
	npm_install_from_pkg_list "$NPM_INSTALLED" "$NPM_PACKAGE_LIST"
	# computer-only npm packages
	case "$ON_OS" in
	android*) ;;
	*)
		npm_install_from_pkg_list "$NPM_INSTALLED" "$COMPUTER_NPM_PACKAGE_LIST"
		;;
	esac
else
	printf "NPM path not where expected (%s), skipping package install...\n" "$NPM_LOC"
	# incase this is the first time this has happened, update npm globally so it gets put into "$NPM_CONFIG_PREFIX"
	npm install --global npm
fi

# install pistol manually
havecmd pistol || env GO111MODULE=on go install -v 'github.com/doronbehar/pistol/cmd/pistol@latest'

echo "Installing personal tools/scripts..."

# install git-only cargo repos
havecmd "wait-for-internet" || cargo install --git "https://github.com/seanbreckenridge/wait-for-internet"

# use bpkg to automate make installs
havecmd bpkg || curl -Lo- "https://raw.githubusercontent.com/bpkg/bpkg/master/setup.sh" | bash
havecmd bpkg || exit $?

set -e
havecmd tttlog || bpkg install -g seanbreckenridge/ttt
havecmd exists || bpkg install -g seanbreckenridge/exists
havecmd genpasswd || bpkg install -g seanbreckenridge/genpasswd
set +e

echo 'Installing basher/shell scripts...'

BASHER_ROOT="${XDG_DATA_HOME}/basher"
[[ ! -d "${BASHER_ROOT}" ]] && git clone --depth=1 'https://github.com/basherpm/basher.git' "${BASHER_ROOT}"
# symlink the single script in the basher bin into .local
havecmd basher || ln -s "${BASHER_ROOT}/bin/basher" "${HOME}/.local/bin"

# install shell scripts using basher
havecmd basher && {
	BASHER_INSTALLED="$(basher list)"
	while read -r bash_pkg; do
		if ! grep -xq "${bash_pkg}" <<<"${BASHER_INSTALLED}"; then
			echo "Installing ${bash_pkg}" 1>&2
			basher install "${bash_pkg}"
		fi
	done < <(spkglist "${BASH_PACKAGE_LIST}")
}

if havecmd reshortcuts; then
	reshortcuts # shortcuts create and format all the created files
else
	printf "Created %d shortcuts\n" "$(python3 -m shortcuts create --debug | wc -l)"
fi

# setup directory for ranger
dir-aliases-ranger

# setup nvim packages
havecmd nvim || exit $?
echo "Installing nvim packages..."
nvim +PlugInstall +qall

echo "Finished bootstrapping!"
