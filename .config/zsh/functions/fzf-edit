# fuzzy search for files/directories and open that in nvim
# If a file is chosen, cd's to that dir and opens the file
# If a dir is chosen, cd's there
# Additional args are forwarded to fd

function fzf-edit() {
	local chosen_file
	local enclosing_dir
	chosen_file="$(fd --full-path -L $@ | fzf +m --preview='${HOME}/.config/fzf_preview {}')" || return
	if [ -d "$chosen_file" ]; then
		cd "$chosen_file"
		zle && { zle reset-prompt; } # change prompt to update PS1 with new CWD
	else
		enclosing_dir=$(dirname "$chosen_file")
		chosen_file=$(basename "$chosen_file")
		cd "$enclosing_dir"
		zle && { zle reset-prompt; } # reset prompt to update PS1
		# if the file is readable, open it in $EDITOR
		if iconv --from-code="utf-8" --to-code="utf-8" "$chosen_file" >/dev/null 2>&1; then
			$EDITOR -cb "$chosen_file"
		fi
		zle-keymap-select # check vi mode to update cursor shape
	fi
}
