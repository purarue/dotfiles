#!/bin/zsh
# Update typically used packages

function update() {
	local START_TIME
	START_TIME="$(date +%s)"
	wait-for-internet --text "(waiting for internet)"
	echo "Updating system (pacman/yay/brew) packages..."
	if [[ -z "${ONLINUX}" ]]; then
		brew update && brew upgrade
		brew upgrade --cask
		# run brew cask upgrade --greedy once per month
		evry 1 month -brewgreedy && brew upgrade --cask --greedy
	else
		yay -Syu
		housekeeping
	fi
	yadm bootstrap
	echo "Updating nvim packages..."
	nvim +PlugUpdate +qall
	echo "Updating doom emacs..."
	doom -y upgrade
	echo "Updating ruby packages..."
	gem update
	echo "Updating python packages..."
	pip install -U -r "${XDG_CONFIG_HOME}/yadm/package_lists/python3_packages.txt"
	update-python-packages
	echo "Updating global npm packages..."
	[[ -n "$NPM_CONFIG_PREFIX" ]] && npm update -g
	echo "Updating global cargo packages..."
	cargo install-update -a
	echo "Updating global go packages..."
	cd || return $?
	spkglist "$HOME/.config/yadm/package_lists/go_packages.txt" | cut -d" " -f2- | xargs go get -u -v 2>&1 | grep "(download)$"
	cd "$OLDPWD" || return $?
	printf "Finished updates in %d seconds\n" "$(($(date +%s) - START_TIME))" | boxes -dshell -pv1h2
}
