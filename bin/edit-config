#!/usr/bin/python3
#
# Bring up a menu to edit common configuration files in a vimbuffer
# A list of names -> filepaths is located at ~/.config/yadm/config_files.txt

import os
import sys
import shlex
import subprocess
import vimbuffer

# load configuration file
config_file = os.path.join(os.path.expanduser("~"), ".config/yadm/config_files.txt")
if not os.path.exists(config_file):
    print(f"Config file at {config_file} doesn't exist", file=sys.stderr)
    sys.exit(1)

# build name -> filepath
config_map = {}
with open(config_file, 'r') as f:
    for line in f:
        # remove comments/empty lines
        if line.strip() and line.strip()[0] != "#":
            file_name, _, file_path = line.strip().partition(' ')
            config_map[file_name] = os.path.abspath(os.path.expanduser(file_path))

# make sure files exist
for path in config_map.values():
    if not os.path.exists(path):
        print(f"'{path}' described in {config_file} doesn't exist.", file=sys.stderr)
        sys.exit(1)

# prompt for user input using rofi
option = subprocess.run(
    shlex.split('rofi -dmenu -p "Pick a config file to edit > "'),
    input="\n".join(config_map.keys()),
    encoding="utf-8",
    stdout=subprocess.PIPE,
    stderr=subprocess.PIPE,
).stdout.strip()

if option:
    if option not in config_map:
        print(f"Couldn't find '{option}' as a choice", file=sys.stderr)
    else:
        vimbuffer.buffer(file=config_map[option], name_prefix=option + "-")

